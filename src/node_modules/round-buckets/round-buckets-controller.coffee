_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $rootScope, $modal, RoundsStore, ContributionsStore, AuthService, BucketsStore, group, round) ->

  $scope.round = round

  currentUser = AuthService.getCurrentUser()
  $scope.canProposeBuckets = group.isAdmin(currentUser) or (
    round.status.name == "pending" and
    round.membersCanProposeBuckets
  )

  delete $rootScope.selectedBucketId
  $scope.isSelected = (bucket) ->
    bucket.id == $rootScope.selectedBucketId

  $scope.saveContribution = (contribution) ->
    # if we're gonna have a bad time
    if round.balanceStatus == 'danger'
      # gtfo
      return
    # if no longer contributing a positive amount
    if not contribution.amount.gt(0)
      if contribution.id
        # remove from contributions store
        ContributionsStore.remove(contribution)
        .then null, (err) ->
          # TODO handle error
      return
    ContributionsStore.save(contribution)
    .then null, (err) ->
      # TODO handle error

  $scope.openNewBucketModal = ->
    $modal.open(
      require('bucket-modal')(
        round: round
        group: group
      )
    ).result.then (bucket) ->
      # TODO add new bucket in proper sort order
      round.buckets.splice(0, 0, bucket)
