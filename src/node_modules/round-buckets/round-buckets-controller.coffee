_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $rootScope, $modal, RoundsStore, ContributionsStore, AuthService, BucketsStore, group, round) ->

  $scope.round = round
  $scope.currentUserId = AuthService.getCurrentUser().id
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  delete $rootScope.selectedBucketId
  $scope.isSelected = (bucket) ->
    bucket.id == $rootScope.selectedBucketId

  $scope.saveContribution = (contribution) ->
    # if we're gonna have a bad time
    if round.balanceStatus == 'danger'
      # gtfo
      return
    # if no longer contributing a positive amount
    if not contribution.amount.gt(0)
      if contribution.id
        # delete contribution
        ContributionsStore.remove(contribution)
      return
    ContributionsStore.save(contribution)

  $scope.openNewBucketModal = ->
    $modal.open(
      require('bucket-modal')(
        round: round
        group: group
        memberships: group.memberships
      )
    ).result.then (bucket) ->
      # TODO add new bucket in proper sort order
      round.buckets.splice(0, 0, bucket)
