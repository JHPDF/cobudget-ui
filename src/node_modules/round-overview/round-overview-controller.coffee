c3 = require('c3')
_ = require('lodash')
debug = require('debug')("round-overview:controller")

errorModal = require('error-modal')

pie = (fixedCosts) ->
  c3.generate
    bindto: '.pie-chart'
    data:
      type: 'pie'
      columns: fixedCosts.map (fixedCost) ->
        [fixedCost.name, fixedCost.amountDollars]

### @ngInject ###
module.exports = ($scope, $modal, FixedCostModel, FixedCostsStore, AuthService, group, round, fixedCosts) ->
  round.set('fixedCosts', fixedCosts)
  $scope.round = round
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  $scope.addFixedCost = ->
    $scope.inserted = round.fixedCosts.add({
      name: "name"
      description: "description"
      amount: 0
      roundId: round.id
    })

  $scope.saveFixedCost = (data, index) ->
    data.amount = data.amountDollars

    fixedCost = round.fixedCosts.at(index)
    fixedCost.set(data)

    debug("saving", fixedCost.serialize(), index)

    FixedCostsStore.save(fixedCost).then (saved) ->
      debug("saved", saved)
      round.fixedCosts.set(fixedCost)
    , (err) ->
      # pass error to xeditable as string
      "Oh noes! :( We had a problem saving, please refresh and try again."


  $scope.removeFixedCost = (index) ->
    fixedCost = round.fixedCosts.at(index)

    debug("removing", fixedCost)

    FixedCostsStore.remove(fixedCost).then ->
      debug("removed")
      round.fixedCosts.remove(fixedCost)
    , (err) ->
      $modal.open(errorModal({ error: err }))

  pie(round.fixedCosts)
  round.fixedCosts.on "all", (eventName) ->
    pie(round.fixedCosts)
