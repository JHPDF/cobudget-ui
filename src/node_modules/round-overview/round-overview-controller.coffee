c3 = require('c3')
_ = require('lodash')
debug = require('debug')("round-overview:controller")

errorModal = require('error-modal')

pie = (fixedCosts) ->
  c3.generate
    bindto: '.pie-chart'
    data:
      type: 'pie'
      columns: _.map fixedCosts, (fixedCost) ->
        [fixedCost.name, fixedCost.amountDollars]

### @ngInject ###
module.exports = ($scope, $modal, FixedCostModel, FixedCostsStore, AuthService, group, round, fixedCosts) ->
  round.fixedCosts = fixedCosts
  $scope.round = round
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  $scope.addFixedCost = ->
    $scope.inserted = new FixedCostModel({
      name: "name"
      description: "description"
      amount: 0
    })
    round.fixedCosts.add($scope.inserted)

  $scope.saveFixedCost = (data, id, index) ->
    data.id = id
    data.roundId = round.id
    data.amount = data.amountDollars

    fixedCost = new FixedCostModel(data)

    debug("saving", fixedCost.serialize(), id, index)

    FixedCostsStore.save(fixedCost).then (saved) ->
      round.fixedCosts.models[index] = fixedCost
    , (err) ->
      # pass error to xeditable as string
      "Oh noes! :( We had a problem saving, please refresh and try again."


  $scope.removeFixedCost = (index) ->
    fixedCost = fixedCosts.models[index]

    debug("removing", fixedCost)

    FixedCostsStore.remove(fixedCost).then ->
      fixedCosts.models.splice(index, 1)
    , (err) ->
      $modal.open(errorModal({ error: err }))

  $scope.$watch 'round.fixedCosts', ->
    pie(round.fixedCosts)
  , true
