c3 = require('c3')
_ = require('lodash')

pie = (fixedCosts) ->
  c3.generate
    bindto: '.pie-chart'
    data:
      type: 'pie'
      columns: _.map fixedCosts, (fixedCost) ->
        [fixedCost.name, fixedCost.amountDollars]

### @ngInject ###
module.exports = ($scope, FixedCostModel, FixedCostsStore, AuthService, group, round, fixedCosts) ->

  $scope.round = round
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  _.forEach fixedCosts, (fixedCost) ->
    round.add(fixedCost)
    return if not _.isUndefined(fixedCost.amountDollars)

    Object.defineProperties fixedCost,
      amountDollars:
        get: ->
          Number(@amount.toFixed(2))
        set: (amountDollars) ->
          @amount = new Decimal(amountDollars or 0)

  $scope.addFixedCost = ->
    $scope.inserted = new FixedCostModel({
      name: "name"
      description: "description"
      amount: 0
    })
    round.fixedCosts.push($scope.inserted)

  $scope.saveFixedCost = (data, id, index) ->
    data.id = id
    data.roundId = round.id
    data.amount = data.amountDollars
    console.log("data on save", data)

    fixedCost = new FixedCostModel(data)

    console.log("saving", fixedCost.serialize(), id, index)

    FixedCostsStore.save(fixedCost).then (saved) ->
      round.fixedCosts[index] = fixedCost

  $scope.removeFixedCost = (index) ->
    fixedCost = fixedCosts[index]

    console.log("removing", fixedCost)

    FixedCostsStore.remove(fixedCost).then ->
      fixedCosts.splice(index, 1)

  $scope.$watch 'round.fixedCosts', ->

    pie(round.fixedCosts)

  , true
