_ = require('lodash')
sum = require('compute-sum')

defineProperties = require('utils/define-properties')

### @ngInject ###
module.exports = (ContributionModel, UserModel, AuthService) ->
  class BucketModel
    constructor: (data = {}) ->
      @id = data.id
      @name = data.name
      @roundId = data.roundId
      @description = data.description
      @user = new UserModel(data.user)
      @targetCents = data.targetCents

      @contributions = _.map data.contributions, (contribution) ->
        # attach bucketId to contribution, as the data
        # returned from the API does not have this
        contrib = _.extend(_.clone(contribution), bucketId: data.id)
        new ContributionModel(contrib)

      defineProperties @,
        contributionTotalCents:
          deps: ['contributions']
          get: ->
            sum(_.pluck @contributions, "amountCents")

        myContributionIndex:
          deps: ['contributions']
          get: ->
            _.findIndex @contributions, (contribution) ->
              contribution.user.id == AuthService.getCurrentUser().id

        myContribution:
          deps: ['myContributionIndex', 'contributions']
          get: ->
            index = @myContributionIndex
            if index != -1
              @contributions[index]
            else
              new ContributionModel({
                user: {
                  id: AuthService.getCurrentUser().id
                }
                bucketId: @id
                amountCents: 0
              })

        groupContributions:
          deps: ['contributions']
          get: ->
            _.filter @contributions, (contribution) ->
              contribution.user.id != AuthService.getCurrentUser.id

        percentageFunded:
          deps: ['contributionTotalCents', 'targetCents']
          get: ->
            (@contributionTotalCents / @targetCents) * 100

        myContributionPercentage:
          deps: ['myContribution', 'targetCents']
          get: ->
            (@myContribution.amountCents / @targetCents) * 100

        groupContributionPercentage:
          deps: ['percentageFunded', 'myContributionPercentage']
          get: ->
            @percentageFunded - @myContributionPercentage

        groupContributionCents:
          deps: ['contributionTotalCents', 'myContribution']
          get: ->
            @contributionTotalCents - @myContribution.amountCents

    serialize: ->
      {
        name: @name
        description: @description
        userId: @user.id
        targetCents: @targetCents
        roundId: @roundId
      }

    getContributionsByUser: () ->
      contributions = {}
      _.each @contributions, (contribution) ->
        contributions[contribution.user.id] = contribution
      contributions
