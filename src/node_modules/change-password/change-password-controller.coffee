_ = require('lodash')
debug = require('debug')("change-password")

### @ngInject ###
module.exports = ($scope, $modalInstance, UsersStore, person) ->

  $scope.person = person

  $scope.submit = (changePassword) ->
    $scope.submitted = true

    if changePassword.$invalid
      debug("invalid", changePassword)
      return

    UsersStore.changePassword({
      id: person.id
      oldPassword: $scope.oldPassword
      newPassword: $scope.newPassword
    })
    .then (result) ->
      $modalInstance.close(result)
    , (err) ->
      # if error, assume bad oldPassword
      # TODO need better error handling from API
      debug("error", err)
      if err.errors.oldPassword[0] == "is incorrect"
        changePassword.oldPassword.$error.bad = true

  $scope.cancel = ->
    $modalInstance.dismiss('cancel')
