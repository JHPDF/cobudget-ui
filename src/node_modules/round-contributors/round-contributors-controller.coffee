_ = require('lodash')

### @ngInject ###
module.exports = ($scope, AuthService, AllocationModel, AllocationsStore, group, round, memberships) ->
  contributors = round.getContributors(memberships)
  allocations = round.getAllocationsByUser()
  $scope.total = round.getTotalAllocationsDollars()
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())


  $scope.contributors = _.filter contributors, (contributor) ->
    # non-admins shouldn't see contributors with no allocations
    $scope.isAdmin or contributor.allocationCents != 0


  $scope.updateAllocation = (contributor, data) ->
    allocation = allocations[contributor.user.id]
    #console.log("allocation", allocation)
    #console.log("data", data)

    if allocation
      allocation.amountCents = data * 100
    else
      allocation = new AllocationModel(
        userId: contributor.user.id
        amountCents: data * 100
        roundId: round.id
      )
      round.allocations.push(allocation)

    # TODO error handling
    AllocationsStore.save(allocation)
    $scope.total = round.getTotalAllocationsDollars()

