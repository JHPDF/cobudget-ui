_ = require('lodash')

### @ngInject ###
module.exports = ($scope, AuthService, group, users, memberships, MembershipModel, MembershipsStore) ->
  group.memberships = memberships

  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())
  $scope.users = users
  $scope.group = group
  $scope.model = selectedUser: null

  $scope.addMember = ->
    membership = new MembershipModel({
      user: $scope.model.selectedUser
      group_id: $scope.group.id
    })
    membership.save(MembershipsStore).then ->
      index = _.sortedIndex memberships, membership, (m) -> m.user.name
      memberships.splice(index, 0, membership)

  $scope.removeMember = (membership, index) ->
    MembershipsStore.remove(membership).then ->
      memberships.splice(index, 1)
