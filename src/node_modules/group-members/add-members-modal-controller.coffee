_ = require('lodash')
Address = require('address-rfc2822')
debug = require('debug')("add-members-modal")

### @ngInject ###
module.exports = ($scope, $modal, $modalInstance, $q, MembershipModel, MembershipsStore, group) ->

  $scope.group = group

  $scope.model = addresses: ""

  $scope.submit = (addMembersForm) ->
    $scope.submitted = true

    if addMembersForm.$invalid
      return

    # validate addresses
    addresses = Address.parse($scope.model.addresses)
    members = _.map addresses, (address) ->
      {
        name: address.name() || null
        email: address.address
      }

    unsavedMemberships = _.map members, (member) ->
      new MembershipModel({
        member: member
        groupId: $scope.group.id
      })

    $q.all(_.map unsavedMemberships, (unsaved) ->
      MembershipsStore.save(unsaved).then null, (err) ->
        debug("save error", err)

        # if membership already exists
        if err.data and err.data.errors and err.data.errors.memberId and
        err.data.errors.memberId[0] == "has already been taken"
          isIgnore: true
          member: unsaved.member
        else
          # mark as error
          err.isError = true
          # add reference to unsaved member
          err.member = unsaved.member
          # pass along to not upset $q.all
          err
    )
    .then (membershipsOrErrors) ->
      ###
        log
        - existing members invited
        - existing members ignored
        - new members invited
        - members errored
      ###
      ret =
        memberships: []
        errors: []
        createdMembers: []
        invitedMembers: []
        ignoredMembers: []
        erroredMembers: []

      savedMemberships = []
      _.forEach membershipsOrErrors, (membershipOrError) ->
        if membershipOrError.isError
          ret.erroredMembers.push(membershipOrError.member)
          ret.errors.push(membershipOrError)
        else if membershipOrError.isIgnore
          ret.ignoredMembers.push(membershipOrError.member)
        else if not membershipOrError.member.initialized
          ret.createdMembers.push(membershipOrError.member)
          ret.memberships.push(membershipOrError)
        else
          ret.invitedMembers.push(membershipOrError.member)
          ret.memberships.push(membershipOrError)

      ret.members = _.map ret.memberships, (ship) -> ship.member

      $modalInstance.close(ret)
    , (err) ->
      $modalInstance.dismiss(err)

  $scope.cancel = ->
    $modalInstance.dismiss(null)
