_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $modalInstance, MembershipModel, MembershipsStore, group, users) ->

  $scope.group = group

  memberIds = _.pluck group.members, 'id'
  $scope.nonMembers = _.filter users, (user) ->
    not _.contains memberIds, user.id

  $scope.model = selectedUser: null

  $scope.submit = (addMembersForm) ->
    $scope.submitted = true

    if addMembersForm.$invalid
      return

    unsavedMembership = new MembershipModel({
      member: $scope.model.selectedUser
      groupId: $scope.group.id
    })

    # TODO error handling
    MembershipsStore.save(unsavedMembership)
    .then (savedMembership) ->
      $modalInstance.close([savedMembership])

  $scope.cancel = ->
    $modalInstance.dismiss('cancel')
