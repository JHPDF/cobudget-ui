_ = require('lodash')

### @ngInject ###
module.exports = (scope, element, attrs) ->

  round = scope.round
  bucket = scope.bucket

  scope.model = {
    myContributionAmount: scope.bucket.myContribution.amount
  }

  scope.$watch "model.myContributionAmount", (amount, oldAmount) ->

    # if amount is Not a Number (NaN)
    if amount != 0 and not amount
      # don't accept number
      amount = oldAmount

    # save amount to bucket contribution
    myContribution = bucket.myContribution
    myContribution.amount = amount

    # if over contributed, cap at allocation
    if round.myAllocationLeftCents < 0
      myContribution.amount += (round.myAllocationLeftCents / 100)
      # change view model too
      scope.model.myContributionAmount = myContribution.amount

    if bucket.myContributionIndex == -1
      bucket.contributions.push(myContribution)
